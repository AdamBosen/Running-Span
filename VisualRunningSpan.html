<!DOCTYPE html>
<html>
	<head>
		<title>Visual Running Span</title>
		<script src="jatos.js"></script>
		<script src="jspsych-7.2.1-dist/jspsych.js"></script>
		<script src="jspsych-7.2.1-dist/plugin-survey-text.js"></script>
		<script src="jspsych-7.2.1-dist/plugin-html-keyboard-response.js"></script>
		<script src="jspsych-7.2.1-dist/plugin-html-button-response.js"></script>
		<script src="jspsych-7.2.1-dist/plugin-instructions.js"></script>
		<script src="jspsych-7.2.1-dist/plugin-survey-text.js"></script>
		<link href="jspsych-7.2.1-dist/jspsych.css" rel="stylesheet" type="text/css"></link>
		<link href="css/Running.css" rel="stylesheet" type="text/css"></link>

		<meta charset="UTF-8">
	</head>
	<body></body>
	<script> 

		
		let jsPsych = initJsPsych({
			on_finish: function() {
					if(jatos.componentJsonInput.sequence == "Demo") {
					//We just finished the demo, so load block 1
					jatos.startComponentByPos(3);
				} else {
					jatos.endStudy(jsPsych.data.get().json());
				}
			}
		});

		jatos.onload(() => {
			const sequenceName = jatos.componentJsonInput.sequence;

			const sequenceFilePath = "ExperimentSequences/" + sequenceName + ".txt";

			//This GET request will work locally only if you are running a local web
			//server to handle the request, JS by default doesn't let you get local files
			//as that could be a major security issue.
			let sequenceFileRequest = new XMLHttpRequest();
			sequenceFileRequest.open("GET", sequenceFilePath,false);
			sequenceFileRequest.send();
			const sequenceText = sequenceFileRequest.responseText;

			const sequence = sequenceText.trim().split('\n');

			//Go through the file sequence and add an audio-keyboard-response object for each file
			let timeline = [];

			let instructionScreen;
			if(sequenceName != "Demo"){
				instructionScreen = {
					type: jsPsychInstructions,
					pages: ['<br><br>Great work! If you have any questions please let us know.',
						'<br><br>We are now going to complete ' + sequence.length  + ' lists.',
						'<br><br>Click Next to begin.'],
					show_clickable_nav: true
				}
			} else {

				instructionScreen = {
					type: jsPsychInstructions,
					pages: [
						'You will see a long list of numbers very quickly.<br>You will not know when the list is going to stop.<br>The list will be too long for you to remember all of the numbers.',
						'<br>Try to remember as many numbers<br>as you can from the <i>end</i> of the list.',
						'When the numbers stop, type in as many numbers<br>as you can remember from the <i>end</i> of the list in order,<br>ending with the last number in the list.',
						'For example, if the list you saw was "8,4,5,1"<br>and you remembered the last two numbers, you would type in 51.<br>If you remembered three, you would type in 451.',
						'<br>Numbers will appear and disappear quickly.<br>Click Next to try a few practice trials.'
						],
					show_clickable_nav: true
				}
			}

			timeline.push(instructionScreen);

			let waitForFirstClick = {
					type: jsPsychHtmlButtonResponse,
					stimulus:"<p>Get ready to remember numbers</p>" + '<p class="trialNumber">1 of ' + sequence.length + "</p>",
					choices:['Click to see the first list of numbers']
			}
			timeline.push(waitForFirstClick); 

			let trialIndex = 0;
			for (trialIndex = 0; trialIndex < sequence.length; trialIndex++)
			{
				//Split the sequence text into an array of digits
				digitList = sequence[trialIndex].split('');
				//This is a bit of a hack, each 'trial' has several elements
				//to control for stimulus duration, ISI, and response period
				for(digitIndex = 0; digitIndex < digitList.length; digitIndex++)
				{
					let showDigit = {
						type: jsPsychHtmlKeyboardResponse,
						stimulus: '<p class="number">' + digitList[digitIndex] + '</p>',
						choices: "NO_KEYS",
						prompt: '<p class="trialNumber">' + (trialIndex + 1) + " of " + sequence.length + "</p>",
						trial_duration: 300,
						response_ends_trial: false,
					}
					timeline.push(showDigit);

					
					let interStimulusInterval = {
						type: jsPsychHtmlKeyboardResponse,
						stimulus: "",
						choices: "NO_KEYS",
						prompt: '<p class="trialNumber">' + (trialIndex + 1) + " of " + sequence.length + "</p>",
						trial_duration: 200,
						response_ends_trial: false,
					}
					timeline.push(interStimulusInterval);
				}

				if(trialIndex < sequence.length-1)
				{
					let enterResponse = {
						type: jsPsychSurveyText,
						preamble: '<p class="trialNumber">' + (trialIndex + 1) + " of " + sequence.length + "</p>",
						questions:[{prompt: "", name: 'Response'}], 
						button_label:'Click or press enter to start the next list',
						on_finish: function(data){
							jsPsych.data.get().addToLast({subjectID:jatos.studySessionData.SubjectID});
							jatos.appendResultData(jsPsych.data.get().last().trials);
						}
					}
					timeline.push(enterResponse);
				} else {
					let lastResponse = {
						type: jsPsychSurveyText,
						preamble: '<p class="trialNumber">' + (trialIndex + 1) + " of " + sequence.length + "</p>",
						questions:[{prompt: "", name: 'Response'}], 
						button_label:'Click to end the experiment',
						on_finish: function(data){
							jsPsych.data.get().addToLast({subjectID:jatos.studySessionData.SubjectID});
							jatos.appendResultData(jsPsych.data.get().last().trials);
						}
					}
					timeline.push(lastResponse);
				}
			}

			jsPsych.run(timeline);
		});

	</script>
</html>
